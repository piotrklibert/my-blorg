<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Piotr Klibert" />
    <meta name="description" content="Exciting new programming Languages and Polyglot programming; also Emacs" />

    <link rel="preload" as="font" href="/statics/fonts/Roboto-Regular.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Italic.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Black.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Black.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" href="/output/base.min.css?cache_busting_cookie=4333" as="style" />

    <link rel="icon" type="image/x-icon" href="/statics/images/favicon.ico" />
    <link href="/statics/base.min.css?cache_busting_cookie=4287" rel="stylesheet" />
    <link href="/statics/styles/my-styles.css?cache_busting_cookie=4202" rel="stylesheet" />
    <link href="/statics/highlight-code.min.css?cache_busting_cookie=4398" rel="stylesheet" />
    <style type="text/css">.example { color: white; }</style>
    <title>How badly can a simple Kotlin function be written? -- Piotr Klibert's blog</title>
  </head>
  <body>

    <header id="blog-header">
      <div id="blog-title">
        <h1>The Right Lang for the Job</h1>
        <div><p>Exploring the abbyss of non-mainstream programming languages</p></div>
      </div>

      <div id="top-menu-container">
        <nav>
          <a href="/">Blog</a>
          <!-- <a href="/articles/archive.html">Archive</a> -->
          <!-- <a href="/articles/programming_langs.html">Languages</a> -->
          <!-- <a href="/articles/about.html">About</a> -->
          <!-- <a href="/articles/contact.html">Contact</a> -->
          <!-- <div id="blog-nav-rss"> -->
          <!-- <a nofolow="1" href="/statics/feed.xml"> -->
          <!-- <img src="/statics/icons/rss0.png" alt="RSS icon" /> -->
          <!-- </a> -->
          <!-- </div> -->
        </nav>
      </div>
    </header>

    <main id="blog-main">
      <div class="blog-main">
        
  <article>
    <header>
      <h1 class="entry-title">
        <a class="title-link" id="how-badly-can-a-simple-kotlin-function-be-written" href="/posts/how-badly-can-a-simple-kotlin-function-be-written.html" title="Read on separate page">
          How badly can a simple Kotlin function be written?
        </a>
        <a href="#how-badly-can-a-simple-kotlin-function-be-written" class="robaczek" title="Link to this place on current page">¶</a>
      </h1>
      
        <h3 class="subtitle">An abomination lurking deep in a production codebase...</h3>
      
      <p class="meta">
        Created: <time>&lt;2023-11-25&gt;</time>
        
      </p>
    </header>

    <p>
This is a real gem, found in the middle of a fairly large codebase for more
than two years:
</p>

<div class="org-src-container">
<pre class="src src-kotlin"><span class="linenr"> 1: </span><span style="color: #8ac6f2; font-weight: bold;">object</span> <span style="color: #92a65e; font-weight: bold;">SomeFileUtils</span> <span style="color: #5f9ea0;">{</span>
<span class="linenr"> 2: </span>    <span style="color: #8ac6f2; font-weight: bold;">fun</span> <span style="color: #cae682;">getFilePath</span><span style="color: #ff66ff;">(</span>context: <span style="color: #92a65e; font-weight: bold;">Context</span>, fileName: <span style="color: #92a65e; font-weight: bold;">String</span>, @<span style="color: #92a65e; font-weight: bold;">RawRes</span> resId: <span style="color: #92a65e; font-weight: bold;">Int</span><span style="color: #ff66ff;">)</span>: <span style="color: #92a65e; font-weight: bold;">String</span> =
<span class="linenr"> 3: </span>        <span style="color: #92a65e; font-weight: bold;">File</span><span style="color: #ff66ff;">(</span>context.filesDir, fileName<span style="color: #ff66ff;">)</span>
<span class="linenr"> 4: </span>            .let <span style="color: #ff66ff;">{</span> file -&gt;
<span class="linenr"> 5: </span>                <span style="color: #8ac6f2; font-weight: bold;">if</span> <span style="color: #00eff0;">(</span>file.canRead<span style="color: #ff6b55;">()</span> &amp;&amp; file.length<span style="color: #ff6b55;">()</span> &gt; 0<span style="color: #00eff0;">)</span> <span style="color: #00eff0;">{</span>
<span class="linenr"> 6: </span>                    file.absolutePath
<span class="linenr"> 7: </span>                <span style="color: #00eff0;">}</span> <span style="color: #8ac6f2; font-weight: bold;">else</span> <span style="color: #00eff0;">{</span>
<span class="linenr"> 8: </span>                    context
<span class="linenr"> 9: </span>                        .resources
<span class="linenr">10: </span>                        .openRawResource<span style="color: #ff6b55;">(</span>resId<span style="color: #ff6b55;">)</span>
<span class="linenr">11: </span>                        .use <span style="color: #ff6b55;">{</span> inputStream -&gt;
<span class="linenr">12: </span>                            file
<span class="linenr">13: </span>                                .outputStream<span style="color: #efef00;">()</span>
<span class="linenr">14: </span>                                .use <span style="color: #efef00;">{</span> outputStream -&gt;
<span class="linenr">15: </span>                                    inputStream.copyTo<span style="color: #b6a0ff;">(</span>outputStream<span style="color: #b6a0ff;">)</span>
<span class="linenr">16: </span>                                <span style="color: #efef00;">}</span>
<span class="linenr">17: </span>                            file.absolutePath
<span class="linenr">18: </span>                        <span style="color: #ff6b55;">}</span>
<span class="linenr">19: </span>                <span style="color: #00eff0;">}</span>
<span class="linenr">20: </span>            <span style="color: #ff66ff;">}</span>
<span class="linenr">21: </span><span style="color: #5f9ea0;">}</span>
</pre>
</div>

<p>
It's so wrong that it's almost beautiful&#x2026; <b>Almost</b>.
</p>

<p>
The person who originally wrote this code must have been a little strange in the
head, which isn't that unusual in this industry. The reviewer of this code who
agreed to merge it - if they even existed - should probably reflect on how
serious they are about doing their job, but well - it happens to the best of us.
A single fuckup like this is nothing too unusual.
</p>

<p>
The real tragedy starts after that, though. Code is read much more often than it
is written, so it had to be read by other programmers in the time it existed.
Especially since many different programmers worked on a project, most of them
only for a short time. Now, not one of these people took it upon themselves to
eradicate this monstrosity, even though it would be 5 minutes of work. Here's
how could it have looked like:
</p>

<div class="org-src-container">
<pre class="src src-kotlin"><span class="linenr"> 1: </span><span style="color: #8ac6f2; font-weight: bold;">import</span> <span style="color: #95e454;">com.companyname.utils.using</span>
<span class="linenr"> 2: </span><span style="color: #8ac6f2; font-weight: bold;">fun</span> <span style="color: #cae682;">createFileForResource</span><span style="color: #5f9ea0;">(</span>context: <span style="color: #92a65e; font-weight: bold;">Context</span>, fileName: <span style="color: #92a65e; font-weight: bold;">String</span>, @<span style="color: #92a65e; font-weight: bold;">RawRes</span> resId: <span style="color: #92a65e; font-weight: bold;">Int</span><span style="color: #5f9ea0;">)</span>: <span style="color: #92a65e; font-weight: bold;">File</span> <span style="color: #5f9ea0;">{</span>
<span class="linenr"> 3: </span>    <span style="color: #8ac6f2; font-weight: bold;">val</span> <span style="color: #cae682;">file</span> = <span style="color: #92a65e; font-weight: bold;">File</span><span style="color: #ff66ff;">(</span>context.filesDir, fileName<span style="color: #ff66ff;">)</span>
<span class="linenr"> 4: </span>    <span style="color: #8ac6f2; font-weight: bold;">if</span> <span style="color: #ff66ff;">(</span>file.canRead<span style="color: #00eff0;">()</span>.not<span style="color: #00eff0;">()</span> || file.length<span style="color: #00eff0;">()</span> == 0L<span style="color: #ff66ff;">)</span> <span style="color: #ff66ff;">{</span>
<span class="linenr"> 5: </span>        <span style="color: #8ac6f2; font-weight: bold;">val</span> <span style="color: #cae682;">resource</span> = context.resources.openRawResource<span style="color: #00eff0;">(</span>resId<span style="color: #00eff0;">)</span>
<span class="linenr"> 6: </span>        using<span style="color: #00eff0;">(</span>resource, file.outputStream<span style="color: #ff6b55;">()</span><span style="color: #00eff0;">)</span> <span style="color: #00eff0;">{</span> input, output -&gt;
<span class="linenr"> 7: </span>            input.copyTo<span style="color: #ff6b55;">(</span>output<span style="color: #ff6b55;">)</span>
<span class="linenr"> 8: </span>        <span style="color: #00eff0;">}</span>
<span class="linenr"> 9: </span>    <span style="color: #ff66ff;">}</span>
<span class="linenr">10: </span>    <span style="color: #8ac6f2; font-weight: bold;">return</span> file
<span class="linenr">11: </span><span style="color: #5f9ea0;">}</span>
</pre>
</div>

<p>
I'll start by appealing to authority (because I'm just as lazy as those that
will, no doubt, persecute me with Uncle Bob quotes):
</p>

<blockquote>
<p>
Sometimes, the elegant implementation is just a function. Not a method. Not a
class. Not a framework. Just a function. – John Carmack
</p>
</blockquote>

<p>
I happen to agree, and it seemed like it was the case in this particular
instance, so that's the first change to the code.
</p>

<p>
Switching to the block body was obvious, since that's the only way to declare
vals in direct function scope, and it looked like giving a name to a
subexpression could be helpful.
</p>

<p>
Flipping the condition not only highlighted the exact conditions (explicitly) in
which the function does something special, but also allowed the use of just an
<code>if</code> statement and dropping the use of <code>else</code> block. It's now clear that,
no matter what happens, this function will return a File object - there's only
one <code>return</code> statement, and it's explicit, making it really hard to miss.
</p>

<p>
Simultaneously using more than one Closeable instance is a pretty
common thing to do, and deserves its own helper function. You can find <code>using</code>
implementation on Github - it's boring, schematic code, so writing it yourself
wouldn't be too fun. It's a single file liberally licensed utility that you can
just copy and paste to your utils module.
</p>

<p>
Finally, since stringly-typed code is an abomination that should be eradicated
from the face of the Earth, we return the <code>File</code> object itself, rather then just
the path to it. The calling code knows better in what form it wants the file to
be: if it's for printing, file path is OK, but if you wanted to read it, you'd
have to create a new <code>File</code> object based on the returned path. It's always
better to leave the representation decisions to the caller, and it pays off to
return the most universal representation you have access to.
</p>

  </article>

      </div>

      <div class="blog-sidebar">

        <div class="sidebar-module sidebar-module-inset">
          You can now subscribe to an
          <a nofolow="1" href="/statics/feed.xml">RSS feed</a>
          <a nofolow="1" href="/statics/feed.xml"><img src="/statics/feed-icon-14x14.png" style="vertical-align: baseline;"/></a>.
        </div>

        <!-- <div class="sidebar-module sidebar-module-inset" id="posts-module"> -->
        <!-- <h4 style="">Latest posts</h4> -->
        <!-- <ol class="list-unstyled posts-links"></ol> -->
        <!-- </div> -->
        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2023</h4>
          <blockquote>
            One of the most surprising things I've witnessed in my lifetime is
            the rebirth of the concept of heresy.
            <footer>— <cite><a href="http://paulgraham.com/heresy.html">Paul Graham</a></cite></footer>
          </blockquote>
        </div>

        <div class="sidebar-module sidebar-module-inset">
          <h4>About me</h4>
          <p>
            I'm a programmer. I like learning programming languages. I've been
            doing it for more than a decade.
          </p>
          <p>
            Here's roughly <a href="/articles/about.html#history">what I learned</a>
            to date.
          </p>
          <p>
            <a href="/articles/contact.html">Contact me</a>
          </p>
        </div>

        <div class="sidebar-module sidebar-module-inset" id="links-module">
          <h4>Links</h4>

          <ol class="links-list">
            <li><a href="https://www.youtube.com/watch?v=m09RWtt5nd8">Video of my talk on FP</a></li>
            <li><a href="/warsawjs-talk/">Slides</a> and <a href="/warsawjs-talk/code.html">Examples</a> for the talk</li>
          </ol>

          <ol class="links-list">
            <li><a href="http://hashrocket.com/blog/posts/taking-advantage-of-the-polyglot-lifestyle">Polyglot Lifestyle</a></li>
            <li><a href="https://hyperpolyglot.org/">HyperPolyglot - language comparisons</a></li>
            <li><a href="https://programming-idioms.org/">Programming Idioms</a></li>
            <li><a href="https://github.com/kanaka/mal/blob/master/process/guide.md">Make a Lisp</a></li>
            <li><a href="http://rosettacode.org/wiki/Rosetta_Code">Rosetta Code</a></li>
            <li><a href="http://pleac.sourceforge.net/">PLEAC - Programming Language Examples Alike Cookbook</a></li>
            <li><a href="http://learnxinyminutes.com/">Learn X in Y Minutes</a></li>
            <li><a href="http://hyperpolyglot.org/">Hyperpolyglot</a></li>
            <li><a href="http://rigaux.org/language-study/syntax-across-languages/">PL syntaxes comparison</a></li>
            <li><a href="https://github.com/kanaka/mal">Make a Lisp</a></li>
            <li><a href="https://modern-sql.com/use-case/literate-sql">Literate SQL</a></li>
            <li><a href="http://en.literateprograms.org/LiteratePrograms:Welcome">Literate Programs</a></li>
            <li><a href="http://radar.oreilly.com/2013/11/polyglot-programming-what-is-it-and-why-should-you-be-using-it.html">Why Polyglot?</a></li>
          </ol>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2022</h4>
          <blockquote>
            It's amazing what you can talk yourself into liking
            <footer>— <cite>Steve Yegge</cite></footer>
          </blockquote>
        </div>


        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2020</h4>
          <blockquote>
            What can change the nature of a man?
            <footer>— <cite>Ravel Puzzlewell</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2017</h4>
          <blockquote>
            One foot in the grave, the other in Hell.
            <footer>— <cite>The Nameless One</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Catch phrase of the Year 2016</h4>
          <blockquote>
            It isn't ideal that...
            <footer>— <cite>many different people</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2015</h4>
          <blockquote>
            You can't type-check being hit by a lightning, can you?
            <footer>
              — <cite>Joe Armstrong, creator of <a href="https://en.wikipedia.org/wiki/Erlang_(programming_language)">Erlang</a></cite>
            </footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2014</h4>
          <blockquote>
            But you <i>do know</i> that non-programmers are
            people, too?
            <footer>— <cite>Michał Kłujszo</cite></footer>
          </blockquote>
        </div>
      </div> <!-- /.blog-sidebar -->
    </main>
    <footer class="blog-footer">
      <p><a href="#">Back to top</a> / <a href="">More posts</a> </p>
    </footer>

    <script src="/statics/bundle.js?cache_busting_cookie=4239"></script>
  </body>
</html>
