<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Piotr Klibert" />
    <meta name="description" content="Exciting new programming Languages and Polyglot programming; also Emacs" />

    <link rel="preload" as="font" href="/statics/fonts/Roboto-Regular.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Italic.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Black.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" as="font" href="/statics/fonts/Roboto-Black.ttf" type="font/ttf" crossorigin="anonymous" />
    <link rel="preload" href="/output/base.min.css?cache_busting_cookie=4333" as="style" />

    <link rel="icon" type="image/x-icon" href="/statics/images/favicon.ico" />
    <link href="/statics/base.min.css?cache_busting_cookie=4287" rel="stylesheet" />
    <link href="/statics/styles/my-styles.css?cache_busting_cookie=4202" rel="stylesheet" />
    <link href="/statics/highlight-code.min.css?cache_busting_cookie=4398" rel="stylesheet" />
    <style type="text/css">.example { color: white; }</style>
    <title>Supercharge your eval-expression with ielm! -- Piotr Klibert's blog</title>
  </head>
  <body>

    <header id="blog-header">
      <div id="blog-title">
        <h1>The Right Lang for the Job</h1>
        <div><p>Exploring the abbyss of non-mainstream programming languages</p></div>
      </div>

      <div id="top-menu-container">
        <nav>
          <a href="/">Blog</a>
          <!-- <a href="/articles/archive.html">Archive</a> -->
          <!-- <a href="/articles/programming_langs.html">Languages</a> -->
          <!-- <a href="/articles/about.html">About</a> -->
          <!-- <a href="/articles/contact.html">Contact</a> -->
          <!-- <div id="blog-nav-rss"> -->
          <!-- <a nofolow="1" href="/statics/feed.xml"> -->
          <!-- <img src="/statics/icons/rss0.png" alt="RSS icon" /> -->
          <!-- </a> -->
          <!-- </div> -->
        </nav>
      </div>
    </header>

    <main id="blog-main">
      <div class="blog-main">
        
  <article>
    <header>
      <h1 class="entry-title">
        <a class="title-link" id="supercharge-your-eval-expression-with-ielm" href="/posts/supercharge-your-eval-expression-with-ielm.html" title="Read on separate page">
          Supercharge your eval-expression with ielm!
        </a>
        <a href="#supercharge-your-eval-expression-with-ielm" class="robaczek" title="Link to this place on current page">Â¶</a>
      </h1>
      
        <h3 class="subtitle">With some tinkering customization, ielm can be a capable replacement</h3>
      
      <p class="meta">
        Created: <time>&lt;2023-12-04 Mon 23:00&gt;</time>
        
          &middot; Updated: <time>&lt;2023-12-06 Wed 14:04&gt;</time>
        
      </p>
    </header>

    <div id="outline-container-supercharge-your-eval-expression-with-ielm!_tldr:-why-and-when" class="outline-2">
<h2 id="supercharge-your-eval-expression-with-ielm!_tldr:-why-and-when"><span class="section-number-2">1.</span> TLDR: why and when</h2>
<div class="outline-text-2" id="text-supercharge-your-eval-expression-with-ielm!_tldr:-why-and-when">
<p>
I often use <code>straight-visit-package</code> and <code>find-library</code> to read the READMEs and
<code>;; Commentary:</code> sections in Elisp files. On top of that, I use Info quite
extensively - the manuals for <a href="https://www.gnu.org/software/emacs/manual/html_mono/elisp.html#Top">Elisp</a> and <a href="https://www.gnu.org/software/emacs/manual/html_mono/org.html#Top">Org Mode</a> are loaded with tons of useful
Elisp snippets.
</p>

<p>
The problem: while you can use <code>C-x C-e</code> almost everywhere, some of the places
listed above are <b>read-only</b> buffers (Info, built-ins from <code>/usr/lib/</code>), so if I
want to evaluate it in a slightly changed form (longer than one line, since that
would fit in <code>eval-expression</code>), I need to switch to scratch buffer, which is
pretty intrusive. With addition of IELM, my workflow looks like this:
</p>

<ol class="org-ol">
<li>I'm reading code or docs in a read-only buffer.</li>
<li>I find a piece of code I want to play with (modify and execute)</li>
<li>If it's one line, I copy it to <code>M-:</code> (<code>eval-expression</code>)</li>
<li>If it's up to 10 lines, I copy it to <code>C-M-:</code> (<code>ielm</code>)</li>
<li>If it's longer, I copy it to <code>*scratch*</code> buffer</li>
</ol>

<p>
In this post, I focus on pt. 4.
</p>

<p>
UPDATE: Another <a href="https://old.reddit.com/user/deaddyfreddy">kind soul on Reddit (/u/deaddyfreddy)</a> pointed at <a href="https://github.com/Fanael/edit-indirect"><code>edit-indirect</code>
package</a> that could be a good replacement for this. I will take a look!
</p>
</div>
</div>
<div id="outline-container-supercharge-your-eval-expression-with-ielm!_eval-expression--~m-:~" class="outline-2">
<h2 id="supercharge-your-eval-expression-with-ielm!_eval-expression--~m-:~"><span class="section-number-2">2.</span> eval-expression / <code>M-:</code></h2>
<div class="outline-text-2" id="text-supercharge-your-eval-expression-with-ielm!_eval-expression--~m-:~">
<p>
Bound under <code>M-:</code> by default, <code>eval-expression</code> allows you to quickly type any
Elisp and execute it in the context of current window and buffer. I think it's
one of my most used key bindings, after <code>M-x</code>. It supports <code>TAB</code>-completion, and
even shows help (function and macro signatures).
</p>


<div id="orgecc237a" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-04_2244.png" alt="screenshot_2023-12-04_2244.png" />
</p>
</div>

<p>
The input takes place in the minibuffer, which means it automatically keeps
history of pevious invokations. You can search through that history, using your
preferred completion styles, for example with Orderless (and Vertico, here) you
can use regular expressions to get what you want:
</p>


<div id="org8c843d0" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-04_2258.png" alt="screenshot_2023-12-04_2258.png" />
</p>
</div>

<p>
Unfortunately, the minibuffer is not the best way to input more complex forms.
Multiline is possible, but tedious. Lack of enabled <code>paredit</code> hurts (and
enabling it messes up incomplete input handling). For these reasons, for trying
out longer pieces of code, I normally switch to the <code>*scratch*</code> buffer. The
downside of it is that I need to switch to a buffer, often losing sight of the
buffer I worked with before that.
</p>

<p>
Fortunately, there's a middle ground: <code>ielm</code>! It's documented with a single page
in the <a href="https://www.gnu.org/software/emacs/manual/html_mono/emacs.html#Lisp-Interaction">Emacs manual</a> and just a handful of customizable options. By default, as
is usual for Emacs, it doesn't look or work too well, but with a bit of
configuration, it gets <b><b>a lot</b></b> better. Here's how I use it.
</p>
</div>
</div>
<div id="outline-container-supercharge-your-eval-expression-with-ielm!_ielm--~c-m-:~" class="outline-2">
<h2 id="supercharge-your-eval-expression-with-ielm!_ielm--~c-m-:~"><span class="section-number-2">3.</span> ielm / <code>C-M-:</code></h2>
<div class="outline-text-2" id="text-supercharge-your-eval-expression-with-ielm!_ielm--~c-m-:~">
<p>
First, let's make <code>ielm</code> look better. As a replacement for <code>eval-expression</code> it
should display at the bottom of the frame. I also prefer it to reduce the
clutter - the default headaer and the prompt could use some tweaking:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr"> 1: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-defun</span> <span style="color: #cae682;">my-make-right-arrow-icon</span> <span style="color: #ff66ff;">()</span>
<span class="linenr"> 2: </span>  <span style="color: #95e454;">"Return a string that displays arrow icon  when inserted in a buffer."</span>
<span class="linenr"> 3: </span>  <span style="color: #ff66ff;">(</span>propertize <span style="color: #00eff0;">(</span>all-the-icons-octicon <span style="color: #95e454;">"arrow-right"</span><span style="color: #00eff0;">)</span>
<span class="linenr"> 4: </span>    'face <span style="color: #ccaa8f;">`</span><span style="color: #00eff0;">(</span><span style="color: #e5786d;">:family</span> <span style="color: #ccaa8f;">,</span><span style="color: #ff6b55;">(</span>all-the-icons-octicon-family<span style="color: #ff6b55;">)</span> <span style="color: #e5786d;">:height</span> 1.2<span style="color: #00eff0;">)</span>
<span class="linenr"> 5: </span>    'display '<span style="color: #00eff0;">(</span>raise 0<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #99968b;">;; </span><span style="color: #99968b;">Make *ielm* buffer display in a side-window at the bottom of the frame</span>
<span class="linenr"> 8: </span><span style="color: #5f9ea0;">(</span>add-to-list 'display-buffer-alist
<span class="linenr"> 9: </span>             '<span style="color: #ff66ff;">(</span><span style="color: #95e454;">"*ielm*"</span>
<span class="linenr">10: </span>               <span style="color: #00eff0;">(</span>display-buffer-in-side-window<span style="color: #00eff0;">)</span>
<span class="linenr">11: </span>               <span style="color: #00eff0;">(</span>side . bottom<span style="color: #00eff0;">)</span>
<span class="linenr">12: </span>               <span style="color: #00eff0;">(</span>window-height . 10<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">setq</span> ielm-header <span style="color: #95e454;">""</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">15: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">setq</span> ielm-prompt <span style="color: #ff66ff;">(</span>concat <span style="color: #00eff0;">(</span>my-make-right-arrow-icon<span style="color: #00eff0;">)</span> <span style="color: #95e454;">" "</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">16: </span>
<span class="linenr">17: </span><span style="color: #5f9ea0;">(</span>keymap-global-set <span style="color: #95e454;">"C-M-:"</span> #'<span style="color: #cae682;">ielm</span><span style="color: #5f9ea0;">)</span>
</pre>
</div>

<p>
We use <code>display-buffer-alist</code> to add a rule for where and how <code>*ielm*</code> buffers
should show up, then remove the header (why waste a line?) and change the prompt
to a shorter one. We get this as a result:
</p>


<div id="orgc7042cb" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-05_2101.png" alt="screenshot_2023-12-05_2101.png" />
</p>
</div>

<p>
Now, let's make the <code>*ielm*</code> buffer behave more like a normal Elisp buffer. I
have <b>a lot</b> of config already in place for Elisp, and since the buffer is not a
minibuffer, most of these will just work. So, I add a few hooks:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr"> 1: </span><span style="color: #99968b;">;; </span><span style="color: #99968b;">*ielm* buffer</span>
<span class="linenr"> 2: </span><span style="color: #5f9ea0;">(</span>add-hook 'ielm-mode-hook 'my-elisp-mode-setup<span style="color: #5f9ea0;">)</span> <span style="color: #99968b;">; </span><span style="color: #99968b;">(1)</span>
<span class="linenr"> 3: </span><span style="color: #5f9ea0;">(</span>add-hook 'ielm-mode-hook 'my-ielm-mode-setup<span style="color: #5f9ea0;">)</span>
<span class="linenr"> 4: </span><span style="color: #5f9ea0;">(</span>keymap-set ielm-map <span style="color: #95e454;">"C-M-:"</span> #'<span style="color: #cae682;">kill-buffer-and-window</span><span style="color: #5f9ea0;">)</span> <span style="color: #99968b;">; </span><span style="color: #99968b;">(2)</span>
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #99968b;">;; </span><span style="color: #99968b;">indirect buffer used by ielm to fontify elisp code</span>
<span class="linenr"> 7: </span><span style="color: #5f9ea0;">(</span>add-hook 'ielm-indirect-setup-hook #'<span style="color: #cae682;">rainbow-delimiters-mode</span><span style="color: #5f9ea0;">)</span> <span style="color: #99968b;">; </span><span style="color: #99968b;">(3)</span>
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">defun</span> <span style="color: #cae682;">my-ielm-mode-setup</span> <span style="color: #ff66ff;">()</span>
<span class="linenr">10: </span>  <span style="color: #ff66ff;">(</span>paredit-mode<span style="color: #ff66ff;">)</span>
<span class="linenr">11: </span>  <span style="color: #ff66ff;">(</span>keymap-local-set <span style="color: #95e454;">"C-&lt;return&gt;"</span> #'<span style="color: #cae682;">my-ielm-send-input</span><span style="color: #ff66ff;">)</span> <span style="color: #99968b;">; </span><span style="color: #99968b;">(4)</span>
<span class="linenr">12: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">let</span> <span style="color: #00eff0;">(</span><span style="color: #ff6b55;">(</span><span style="color: #cae682;">map</span> <span style="color: #efef00;">(</span>copy-keymap paredit-mode-map<span style="color: #efef00;">)</span><span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span>
<span class="linenr">13: </span>    <span style="color: #00eff0;">(</span>keymap-set map <span style="color: #95e454;">"&lt;RET&gt;"</span> 'ielm-return<span style="color: #00eff0;">)</span>
<span class="linenr">14: </span>    <span style="color: #00eff0;">(</span><span style="color: #8ac6f2; font-weight: bold;">push</span> <span style="color: #ccaa8f;">`</span><span style="color: #ff6b55;">(</span>paredit-mode . <span style="color: #ccaa8f;">,</span>map<span style="color: #ff6b55;">)</span> minor-mode-overriding-map-alist<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">15: </span>
<span class="linenr">16: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-defun</span> <span style="color: #cae682;">my-ielm-send-input</span> <span style="color: #ff66ff;">()</span>
<span class="linenr">17: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">interactive</span><span style="color: #ff66ff;">)</span>
<span class="linenr">18: </span>  <span style="color: #99968b;">;; </span><span style="color: #99968b;">The pattern of: '&lt;return&gt; SHIT, I meant execute! C-/ C-&lt;return&gt;' repeats</span>
<span class="linenr">19: </span>  <span style="color: #99968b;">;; </span><span style="color: #99968b;">iself often enough that automation seems warranted... :)</span>
<span class="linenr">20: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">when</span> <span style="color: #00eff0;">(</span>eq 'ielm-return last-command<span style="color: #00eff0;">)</span> <span style="color: #00eff0;">(</span>undo<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span>
<span class="linenr">21: </span>  <span style="color: #ff66ff;">(</span>ielm-send-input<span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
</pre>
</div>

<p>
<code>my-elisp-mode-setup</code> (at <code>(1)</code>) is a hook I run in normal Elisp buffers. It
enables tens of packages and messes with a lot of keybindings, you can see it <a href="https://gist.github.com/piotrklibert/44801d13513ac1c9aca5b4522bbbde79">on
Github</a>. <code>my-ielm-mode-setup</code> only overrides some key bindings - <code>paredit</code>
would normally hijack the <code>RET</code> key, so we use <a href="https://www.gnu.org/software/emacs/manual/html_mono/elisp.html#Controlling-Active-Maps">minor-mode-overriding-map-alist</a>
to tell it not to do that. With that, we have a nice multiline editing,
structural editing with paredit, and fontification and indentation that work:
</p>


<div id="org62a36d5" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-05_2116.png" alt="screenshot_2023-12-05_2116.png" />
</p>
</div>

<p>
With <code>ielm-dynamic-multiline-inputs</code> and <code>ielm-dynamic-return</code> set, we can now
insert newlines normally as long as we're not at the very end of the input.
Having to move point to the end to execute the code can be tedious, so I bound
<code>C-&lt;return&gt;</code> to send the input immediately, no matter where the point currently
is.
</p>

<p>
Since this is a normal Elisp buffer, we can also use <code>C-M-x</code> and <code>C-x C-e</code> to
execute <b>parts</b> of the current input. That allows you to refine the input before
actually executing it.
</p>

<p>
Going further, one of the nice things about <code>eval-expression</code> is that it works
in the context of the current window and buffer. I didn't want to mess with how
IELM executes its input; instead, I made a little helper function:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr"> 1: </span><span style="color: #5f9ea0;">(</span>keymap-global-set <span style="color: #95e454;">"C-M-:"</span> #'<span style="color: #cae682;">my-run-ielm</span><span style="color: #5f9ea0;">)</span>
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-defun</span> <span style="color: #cae682;">my-run-ielm</span> <span style="color: #ff66ff;">(</span><span style="color: #cae682;">arg</span><span style="color: #ff66ff;">)</span>
<span class="linenr"> 4: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">interactive</span> <span style="color: #95e454;">"P"</span><span style="color: #ff66ff;">)</span>
<span class="linenr"> 5: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">let</span> <span style="color: #00eff0;">(</span><span style="color: #ff6b55;">(</span><span style="color: #cae682;">buf</span> <span style="color: #efef00;">(</span>buffer-name <span style="color: #b6a0ff;">(</span>current-buffer<span style="color: #b6a0ff;">)</span><span style="color: #efef00;">)</span><span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span>
<span class="linenr"> 6: </span>    <span style="color: #00eff0;">(</span>ielm<span style="color: #00eff0;">)</span>
<span class="linenr"> 7: </span>    <span style="color: #00eff0;">(</span><span style="color: #8ac6f2; font-weight: bold;">when</span> arg
<span class="linenr"> 8: </span>      <span style="color: #ff6b55;">(</span>insert
<span class="linenr"> 9: </span>       <span style="color: #efef00;">(</span>prin1-to-string
<span class="linenr">10: </span>        <span style="color: #b6a0ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">pcase</span> arg
<span class="linenr">11: </span>          <span style="color: #5f9ea0;">(</span>'<span style="color: #79a8ff;">(</span>4<span style="color: #79a8ff;">)</span> <span style="color: #ccaa8f;">`</span><span style="color: #79a8ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">with-selected-window</span> <span style="color: #f78fe7;">(</span>get-buffer-window <span style="color: #ccaa8f;">,</span>buf<span style="color: #f78fe7;">)</span><span style="color: #79a8ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">12: </span>          <span style="color: #5f9ea0;">(</span>'<span style="color: #79a8ff;">(</span>16<span style="color: #79a8ff;">)</span> <span style="color: #ccaa8f;">`</span><span style="color: #79a8ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">with-current-buffer</span> <span style="color: #ccaa8f;">,</span>buf<span style="color: #79a8ff;">)</span><span style="color: #5f9ea0;">)</span><span style="color: #b6a0ff;">)</span><span style="color: #efef00;">)</span><span style="color: #ff6b55;">)</span>
<span class="linenr">13: </span>      <span style="color: #ff6b55;">(</span>forward-char -1<span style="color: #ff6b55;">)</span>
<span class="linenr">14: </span>      <span style="color: #ff6b55;">(</span>ielm-return<span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
</pre>
</div>

<p>
Now, when I want to execute some code in the context of a window or buffer I was
before invoking IELM, I can press <code>C-u C-M-:</code> or <code>C-u C-u C-M-:</code>. This is what I
get in that case:
</p>


<div id="org9ad0ac2" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-05_2131.png" alt="screenshot_2023-12-05_2131.png" />
</p>
</div>

<p>
I can now use things like <code>re-search-forward</code> in the context of the window I was
in before switching to IELM - and see the point move as the command gets
executed.
</p>

<p>
Finally, remember the "help" that <code>eval-expression</code> offers? Since <code>*ielm*</code> is a
normal buffer, it can do a lot more - for example, you can use it with Corfu:
</p>


<div id="orge39ce98" class="figure">
<p><img src="/posts/./data/ba/61d0fa-c051-4d8b-9d8a-71cf33867960/screenshot_2023-12-05_2143.png" alt="screenshot_2023-12-05_2143.png" />
</p>
</div>

<p>
Of course, all the other goodies you have configured for <code>emacs-lisp-mode</code> will
also work. This is the ultimate advantage of this solution over
<code>eval-expression</code>, in my opinion.
</p>
</div>
</div>
<div id="outline-container-supercharge-your-eval-expression-with-ielm!_conclusion" class="outline-2">
<h2 id="supercharge-your-eval-expression-with-ielm!_conclusion"><span class="section-number-2">4.</span> Conclusion</h2>
<div class="outline-text-2" id="text-supercharge-your-eval-expression-with-ielm!_conclusion">
<p>
One thing missing is saving and searching of the history of commands. It's kept
in <code>comint</code>, I think, and is not persistent. Recalling previous commands in a
single IELM session (with <code>C-&lt;up&gt;</code>) works, but <code>C-r</code> starts an <code>isearch</code> of
the buffer instead of Orderless search with Vertico. This is something I still
need to figure out.
</p>

<p>
UPDATE: a kind soul <a href="https://old.reddit.com/user/FrankLeeMadear">over at Reddit (/u/FrankLeeMadear)</a> provided the missing
piece for me! Thank you, I will use it well! ðŸ™‚
</p>

<p>
UPDATE: The code was a little buggy - it required some conversions between the
ring and a list. It works now, including persistence between Emacs restarts.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="linenr"> 1: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">defvar</span> <span style="color: #cae682;">ielm-input-history</span> nil
<span class="linenr"> 2: </span>  <span style="color: #95e454;">"History of input entered in ielm buffers. Persistent across sessions."</span><span style="color: #5f9ea0;">)</span>
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-defun</span> <span style="color: #cae682;">my-ielm-get-history</span> <span style="color: #ff66ff;">()</span>
<span class="linenr"> 5: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">unless</span> <span style="color: #00eff0;">(</span>get-buffer <span style="color: #95e454;">"*ielm*"</span><span style="color: #00eff0;">)</span>
<span class="linenr"> 6: </span>    <span style="color: #00eff0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-return-from</span> my-ielm-get-history ielm-input-history<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span>
<span class="linenr"> 7: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">let*</span> <span style="color: #00eff0;">(</span><span style="color: #ff6b55;">(</span><span style="color: #cae682;">input-ring</span> <span style="color: #efef00;">(</span><span style="color: #8ac6f2; font-weight: bold;">if</span> <span style="color: #b6a0ff;">(</span>eq major-mode 'inferior-emacs-lisp-mode<span style="color: #b6a0ff;">)</span>
<span class="linenr"> 8: </span>                         comint-input-ring
<span class="linenr"> 9: </span>                       <span style="color: #b6a0ff;">(</span>buffer-local-value 'comint-input-ring
<span class="linenr">10: </span>                                           <span style="color: #5f9ea0;">(</span>get-buffer <span style="color: #95e454;">"*ielm*"</span><span style="color: #5f9ea0;">)</span><span style="color: #b6a0ff;">)</span><span style="color: #efef00;">)</span><span style="color: #ff6b55;">)</span>
<span class="linenr">11: </span>         <span style="color: #ff6b55;">(</span><span style="color: #cae682;">input-list</span> <span style="color: #efef00;">(</span>-map #'<span style="color: #cae682;">substring-no-properties</span> <span style="color: #b6a0ff;">(</span>ring-elements input-ring<span style="color: #b6a0ff;">)</span><span style="color: #efef00;">)</span><span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span>
<span class="linenr">12: </span>    <span style="color: #00eff0;">(</span>-uniq <span style="color: #ff6b55;">(</span>append input-list ielm-input-history<span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">cl-defun</span> <span style="color: #cae682;">my-ielm-search-history</span> <span style="color: #ff66ff;">()</span>
<span class="linenr">15: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">interactive</span><span style="color: #ff66ff;">)</span>
<span class="linenr">16: </span>  <span style="color: #ff66ff;">(</span>insert <span style="color: #00eff0;">(</span>completing-read <span style="color: #95e454;">"History: "</span> <span style="color: #ff6b55;">(</span>my-ielm-get-history<span style="color: #ff6b55;">)</span><span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">17: </span>
<span class="linenr">18: </span><span style="color: #5f9ea0;">(</span><span style="color: #8ac6f2; font-weight: bold;">defun</span> <span style="color: #cae682;">save-ielm-input-history</span> <span style="color: #ff66ff;">()</span>
<span class="linenr">19: </span>  <span style="color: #ff66ff;">(</span><span style="color: #8ac6f2; font-weight: bold;">setq</span> ielm-input-history <span style="color: #00eff0;">(</span>my-ielm-get-history<span style="color: #00eff0;">)</span><span style="color: #ff66ff;">)</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">20: </span>
<span class="linenr">21: </span><span style="color: #5f9ea0;">(</span>add-hook 'savehist-save-hook #'<span style="color: #cae682;">save-ielm-input-history</span><span style="color: #5f9ea0;">)</span>
<span class="linenr">22: </span><span style="color: #5f9ea0;">(</span>add-to-list 'savehist-additional-variables 'ielm-input-history<span style="color: #5f9ea0;">)</span>
</pre>
</div>

<p>
Other than that, I think this config fits nicely between <code>eval-expression</code> and
visiting an Elisp buffer (scratch or otherwise). I've been using this for a few
weeks to experiment and play with new libraries. Being able to choose in which
context the code will be executed is convenient, and the full power of
structural editing and completion with Corfu even for throwaway snippets helps a
lot when exploring and prototyping code.
</p>
</div>
</div>

  </article>

      </div>

      <div class="blog-sidebar">

        <div class="sidebar-module sidebar-module-inset">
          You can now subscribe to an
          <a nofolow="1" href="/statics/feed.xml">RSS feed</a>
          <a nofolow="1" href="/statics/feed.xml"><img src="/statics/feed-icon-14x14.png" style="vertical-align: baseline;"/></a>.
        </div>

        <!-- <div class="sidebar-module sidebar-module-inset" id="posts-module"> -->
        <!-- <h4 style="">Latest posts</h4> -->
        <!-- <ol class="list-unstyled posts-links"></ol> -->
        <!-- </div> -->
        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2023</h4>
          <blockquote>
            One of the most surprising things I've witnessed in my lifetime is
            the rebirth of the concept of heresy.
            <footer>â€” <cite><a href="http://paulgraham.com/heresy.html">Paul Graham</a></cite></footer>
          </blockquote>
        </div>

        <div class="sidebar-module sidebar-module-inset">
          <h4>About me</h4>
          <p>
            I'm a programmer. I like learning programming languages. I've been
            doing it for more than a decade.
          </p>
          <p>
            Here's roughly <a href="/articles/about.html#history">what I learned</a>
            to date.
          </p>
          <p>
            <a href="/articles/contact.html">Contact me</a>
          </p>
        </div>

        <div class="sidebar-module sidebar-module-inset" id="links-module">
          <h4>Links</h4>

          <ol class="links-list">
            <li><a href="https://www.youtube.com/watch?v=m09RWtt5nd8">Video of my talk on FP</a></li>
            <li><a href="/warsawjs-talk/">Slides</a> and <a href="/warsawjs-talk/code.html">Examples</a> for the talk</li>
          </ol>

          <ol class="links-list">
            <li><a href="http://hashrocket.com/blog/posts/taking-advantage-of-the-polyglot-lifestyle">Polyglot Lifestyle</a></li>
            <li><a href="https://hyperpolyglot.org/">HyperPolyglot - language comparisons</a></li>
            <li><a href="https://programming-idioms.org/">Programming Idioms</a></li>
            <li><a href="https://github.com/kanaka/mal/blob/master/process/guide.md">Make a Lisp</a></li>
            <li><a href="http://rosettacode.org/wiki/Rosetta_Code">Rosetta Code</a></li>
            <li><a href="http://pleac.sourceforge.net/">PLEAC - Programming Language Examples Alike Cookbook</a></li>
            <li><a href="http://learnxinyminutes.com/">Learn X in Y Minutes</a></li>
            <li><a href="http://hyperpolyglot.org/">Hyperpolyglot</a></li>
            <li><a href="http://rigaux.org/language-study/syntax-across-languages/">PL syntaxes comparison</a></li>
            <li><a href="https://github.com/kanaka/mal">Make a Lisp</a></li>
            <li><a href="https://modern-sql.com/use-case/literate-sql">Literate SQL</a></li>
            <li><a href="http://en.literateprograms.org/LiteratePrograms:Welcome">Literate Programs</a></li>
            <li><a href="http://radar.oreilly.com/2013/11/polyglot-programming-what-is-it-and-why-should-you-be-using-it.html">Why Polyglot?</a></li>
          </ol>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2022</h4>
          <blockquote>
            It's amazing what you can talk yourself into liking
            <footer>â€” <cite>Steve Yegge</cite></footer>
          </blockquote>
        </div>


        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2020</h4>
          <blockquote>
            What can change the nature of a man?
            <footer>â€” <cite>Ravel Puzzlewell</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2017</h4>
          <blockquote>
            One foot in the grave, the other in Hell.
            <footer>â€” <cite>The Nameless One</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Catch phrase of the Year 2016</h4>
          <blockquote>
            It isn't ideal that...
            <footer>â€” <cite>many different people</cite></footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2015</h4>
          <blockquote>
            You can't type-check being hit by a lightning, can you?
            <footer>
              â€” <cite>Joe Armstrong, creator of <a href="https://en.wikipedia.org/wiki/Erlang_(programming_language)">Erlang</a></cite>
            </footer>
          </blockquote>
        </div>

        <div class="quote-of-the-year sidebar-module sidebar-module-inset">
          <h4 style="text-align: center">Quote of the Year 2014</h4>
          <blockquote>
            But you <i>do know</i> that non-programmers are
            people, too?
            <footer>â€” <cite>MichaÅ‚ KÅ‚ujszo</cite></footer>
          </blockquote>
        </div>
      </div> <!-- /.blog-sidebar -->
    </main>
    <footer class="blog-footer">
      <p><a href="#">Back to top</a> / <a href="">More posts</a> </p>
    </footer>

    <script src="/statics/bundle.js?cache_busting_cookie=4239"></script>
  </body>
</html>
